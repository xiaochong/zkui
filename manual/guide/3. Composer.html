<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>3. Composer</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    <h1><a name="3. Composer">3. Composer</a></h1>A composer is responsible to initialize a component (or a component of tree) when ZK loader is composing a component. It is the controller in the MVC pattern, while the component is the view,which separate the code from the user interfaces.
<h2><a name="3.1 Creating a composer">3.1 Creating a composer</a></h2>Composers can be created with the create-composer target. For example try running the following command from the root of a Grails project:
<div class="code"><pre>grails create&#45;composer window</pre></div><p class="paragraph"/>The command will result in the creation of a composer at the location grails-app/composers/WindowComposer.groovy:
<div class="code"><pre>class WindowComposer &#123;
    def afterCompose = &#123;Component comp &#45;&#62;
        // initialize components here
    &#125;
&#125;</pre></div>
WindowComposer by default provide a <code>afterCompose</code> closure to initialize components.<p class="paragraph"/><blockquote class="note">
The create-composer command is merely for convenience and you can just as easily create composers using your favorite text editor or IDE
</blockquote><h2><a name="3.2 Apply a composer">3.2 Apply a composer</a></h2>Each component Taglib has a <code>apply</code> attribute,so you can place the composer here
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window id=<span class="xml&#45;quote">"myWindowComposer"</span> apply=<span class="xml&#45;quote">"package.WindowComposer"</span>&#62;</span>
    &#8230;
<span class="xml&#45;tag">&#60;/z:window&#62;</span></pre></div><p class="paragraph"/>In the WindowComposer side
<div class="code"><pre>def afterCompose = &#123;Component comp &#45;&#62;
    assert comp.id==<span class="java&#45;quote">"myWindowComposer"</span>
    assert (comp <span class="java&#45;keyword">instanceof</span> org.zkoss.zul.Window)
&#125;</pre></div><h2><a name="3.3 Auto-wired Component">3.3 Auto-wired Component</a></h2>If apply a <code>composer</code> to a Component that implement a <code>IdSpace</code> Interface,such as org.zkoss.zul.Window. The Component's children can be auto-wired to composer's fields<p class="paragraph"/>The following is an example. The onChange event received by Textbox <code>mytextbox</code> will be forwarded to target Window <code>mywin</code> as a new target event onChange_mytextbox and the Textbox component with id name "mytextbox" and Label with id name <code>mylabel</code> are injected into the "mytextbox" and "mylabel" fields respectively(so you can use mytextbox and mylabel variable directly in onChange_mytextbox without problem).<p class="paragraph"/>Composer
<div class="code"><pre>class MyComposer&#123;
    Textbox mytextbox
    Window self //embeded object, the supervised window <span class="java&#45;quote">"mywin"</span>
    Page page //the ZK page
    Label mylabel<p class="paragraph"/>    def afterCompose = &#123;Component comp &#45;&#62;
        assert mytextbox.id==<span class="java&#45;quote">"mytextbox"</span>
        assert mylabel.id==<span class="java&#45;quote">"mylabel"</span>
    &#125;<p class="paragraph"/>    def onChange_mytextbox(Event event) &#123;
        mylabel.setValue(<span class="java&#45;quote">"You just entered: "</span>+ mytextbox.getValue())
    &#125;
&#125;</pre></div><p class="paragraph"/>View
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window id=<span class="xml&#45;quote">"mywin"</span> apply=<span class="xml&#45;quote">"MyComposer"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox id=<span class="xml&#45;quote">"mytextbox"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;z:label id=<span class="xml&#45;quote">"mylabel"</span>/&#62;</span>
<span class="xml&#45;tag">&#60;/z:window&#62;</span></pre></div><h2><a name="3.4 Redirects">3.4 Redirects</a></h2>
Actions can be redirected using the redirect method present in all composers<p class="paragraph"/>The parameters of <code>redirect</code> is same as controller's <code>redirect</code><p class="paragraph"/>Composer
<div class="code"><pre>class MyComposer&#123;
    Button mybutton<p class="paragraph"/>    def afterCompose = &#123;Component comp &#45;&#62;<p class="paragraph"/>    &#125;<p class="paragraph"/>    def onClick_mybutton(Event event) &#123;
        redirect(controller: 'demo', action: 'index', id: 1)
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
following code same as <code>onClick_button</code> above<p class="paragraph"/><div class="code"><pre>def afterCompose = &#123;Component comp &#45;&#62;
    mybutton.addEventListener('onClick')&#123;
        redirect(controller: 'demo', action: 'index', id: 1)
    &#125;
&#125;</pre></div><p class="paragraph"/></blockquote><p class="paragraph"/>
View
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window id=<span class="xml&#45;quote">"mywin"</span> apply=<span class="xml&#45;quote">"MyComposer"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;z:button label=<span class="xml&#45;quote">"mybutton"</span>/&#62;</span>
<span class="xml&#45;tag">&#60;/z:window&#62;</span></pre></div><p class="paragraph"/><h2><a name="3.5 Data Binding">3.5 Data Binding</a></h2>
To uses Grails' underlying data binding capability,<code>zkui</code> injection a <code>getParams</code> method to <a href="http://www.zkoss.org/javadoc/latest/zk/org/zkoss/zk/ui/Component.html" target="blank">Component</a>.<p class="paragraph"/>Domain Class
<div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName
    <span class="java&#45;object">String</span> fullName
    <span class="java&#45;keyword">static</span> constraints = &#123;
    &#125;
&#125;</pre></div><p class="paragraph"/>View
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window id=<span class="xml&#45;quote">"mywin"</span> apply=<span class="xml&#45;quote">"MyComposer"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox name=<span class="xml&#45;quote">"firstName"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox name=<span class="xml&#45;quote">"lastName"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox name=<span class="xml&#45;quote">"fullName"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;z:button label=<span class="xml&#45;quote">"submit"</span>/&#62;</span>
<span class="xml&#45;tag">&#60;/z:window&#62;</span></pre></div><p class="paragraph"/>Composer
<div class="code"><pre>class MyComposer&#123;
    Button submit
    def afterCompose = &#123;Component mywin &#45;&#62;
        submit.addEventListener('onClick')&#123;
            def person=<span class="java&#45;keyword">new</span> Person(mywin.params)
            &#8230;
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>A <code>bindData</code> method same as in <code>controller</code> also provide to Composer<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Person()
bindData(p, mywin.params)</pre></div>
<h2><a name="3.6 Unit Test">3.6 Unit Test</a></h2>When use <strong class="bold">grails create-composer</strong> create a composer,a unit class that is a sub-class of ComposerUnitTestCase also created<p class="paragraph"/>It provides a <code>mockComposer</code> methods for mocking zkui's  Selector,Builder and so on.<p class="paragraph"/><div class="code"><pre>mockComposer(MyComposer)
def myComposer=<span class="java&#45;keyword">new</span> MyComposer
...</pre></div>
<h2><a name="3.7 Render Errors">3.7 Render Errors</a></h2><code>zkui</code> injection a <code>renderErrors</code> method to <a href="http://www.zkoss.org/javadoc/latest/zk/org/zkoss/zk/ui/Component.html" target="blank">Component</a>.<p class="paragraph"/>If you have Domain class
<div class="code"><pre>class Book&#123;
    <span class="java&#45;object">String</span> author
    <span class="java&#45;object">String</span> title
&#125;</pre></div><p class="paragraph"/>In View
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window id=<span class="xml&#45;quote">"formWindow"</span> title=<span class="xml&#45;quote">"demo"</span> apply=<span class="xml&#45;quote">"your.Composer"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox name=<span class="xml&#45;quote">"author"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox name=<span class="xml&#45;quote">"title"</span>/&#62;</span>
    &#8230;
<span class="xml&#45;tag">&#60;/z:window&#62;</span></pre></div><p class="paragraph"/>Then in <code>your.Composer</code> use renderErrors<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">if</span> (!book.save()) &#123;
            formWindow.renderErrors(bean: book)
 &#125;</pre></div><p class="paragraph"/>
In addition,you can also use grails's traditional <code>renderErrors</code><p class="paragraph"/>In <code>your.Composer</code>
<div class="code"><pre><span class="java&#45;keyword">if</span> (!book.save()) &#123;
    flash.book = book
    redirect(controller: <span class="java&#45;quote">"book"</span>, action: <span class="java&#45;quote">"edit"</span>, id: book.id)
 &#125;</pre></div><p class="paragraph"/>In your view
<div class="code"><pre><span class="xml&#45;tag">&#60;g:hasErrors bean=<span class="xml&#45;quote">"$&#123;flash.book&#125;"</span>&#62;</span>
<span class="xml&#45;tag">&#60;div class=<span class="xml&#45;quote">"errors"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;g:renderErrors bean=<span class="xml&#45;quote">"$&#123;flash.book&#125;"</span> as=<span class="xml&#45;quote">"list"</span> /&#62;</span>
<span class="xml&#45;tag">&#60;/div&#62;</span>
<span class="xml&#45;tag">&#60;/g:hasErrors&#62;</span></pre></div><p class="paragraph"/>
<h2><a name="3.8 ZK's Data Binding">3.8 ZK's Data Binding</a></h2>Data binding is a mechanism that automates the data-copy plumbing code (CRUD) between UI components and the data source. Application developers only have to tell the data binding manager about the associations between UI components and the data source. Then, the data -binding manager will do all the loading (loading data from the data source to UI components) and saving (saving data from UI component into the data source) jobs automatically.<p class="paragraph"/><h3>Activates Data Binding Manager</h3>
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window  apply=<span class="xml&#45;quote">"org.zkoss.demo.MyComposer,org.zkoss.zkplus.databind.AnnotateDataBindingComposer"</span>&#62;</span>
<span class="xml&#45;tag">&#60;/z:window&#62;</span></pre></div><p class="paragraph"/>For more information, please refer to the relative blog post <a href="http://blog.zkoss.org/index.php/2011/08/11/databinding-composer/" target="blank">Databinding Composer</a><p class="paragraph"/><h3>Associate UI Components with Data Source</h3>
After activating the data-binding manager, you have to define the required UI objects and then associate them with the data source.<p class="paragraph"/>In the gsp view:
<div class="code"><pre><span class="xml&#45;tag">&#60;z:window id=<span class="xml&#45;quote">"win"</span> apply=<span class="xml&#45;quote">"test.TestComposer,org.zkoss.zkplus.databind.AnnotateDataBindingComposer"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;z:textbox value=<span class="xml&#45;quote">"@&#123;win&#35;composer.username&#125;"</span>/&#62;</span>
<span class="xml&#45;tag">&#60;z:/window&#62;</span></pre></div><p class="paragraph"/>In the test.TestComposer:
<div class="code"><pre>class TestComposer&#123;<p class="paragraph"/>    def username=<span class="java&#45;quote">"test"</span><p class="paragraph"/>    def afterCompose = &#123;Component comp &#45;&#62;
        &#8230;
    &#125;
&#125;</pre></div><p class="paragraph"/>See more <a href="http://books.zkoss.org/wiki/ZK%20Developer's%20Reference/Data%20Binding" target="blank">ZK Developer&#39;s Reference/Data Binding</a><p class="paragraph"/>

    </body>
</html>
